# ============================================================
# VALIDATOR ENCLAVE DOCKERFILE
# ============================================================
# This Dockerfile builds the validator TEE enclave image.
#
# TWO-STAGE REPRODUCIBILITY:
# 1. Base image (Dockerfile.base) - built ONCE with yum install, cached
# 2. This Dockerfile - uses base, only does COPY operations = deterministic
#
# IMPORTANT: Before building, ensure base image exists:
#   docker build -f validator_tee/Dockerfile.base -t validator-base:v1 .
#
# WHY THIS APPROACH?
# - yum install is non-deterministic (different file order each time)
# - By using a cached base image, we skip the non-deterministic step
# - All operations here (COPY, pip install) become deterministic
# - Combined with post-build timestamp normalization = reproducible PCR0
#
# HOW TO UPDATE (for security patches):
# 1. Rebuild base image (see Dockerfile.base)
# 2. Rebuild this image
# ============================================================

# Use the pre-built base image with Python already installed
# This MUST be built first: docker build -f Dockerfile.base -t validator-base:v1 .
FROM validator-base:v1

# =============================================================================
# Set SOURCE_DATE_EPOCH for reproducible timestamps
# This forces all file timestamps to 1970-01-01 00:00:00 UTC
# =============================================================================
ENV SOURCE_DATE_EPOCH=0

# Copy requirements and install dependencies
# --no-cache-dir: prevents pip cache from affecting image
# --no-compile: skips .pyc generation (bytecode has embedded timestamps)
COPY validator_tee/enclave/requirements.txt /tmp/requirements.txt
RUN python3 -m pip install --no-cache-dir --no-compile -r /tmp/requirements.txt

# =============================================================================
# Normalize timestamps on all installed Python packages
# Even with SOURCE_DATE_EPOCH, some tools ignore it
# =============================================================================
RUN find /usr/lib/python3.7 -type f -exec touch -t 197001010000.00 {} + 2>/dev/null || true
RUN find /usr/lib64/python3.7 -type f -exec touch -t 197001010000.00 {} + 2>/dev/null || true

# Set working directory
WORKDIR /app

# Copy enclave-specific files (runs INSIDE the enclave)
COPY validator_tee/enclave/ /app/validator_tee/enclave/

# Copy leadpoet_canonical module (for canonical weight hashing)
COPY leadpoet_canonical/ /app/leadpoet_canonical/

# =============================================================================
# CRITICAL: Include validation logic for PCR0 verification
# These files are included in the enclave image so they're part of PCR0.
# If validator.py or automated_checks.py changes, PCR0 changes.
# The gateway independently builds this image to verify PCR0.
# =============================================================================
COPY neurons/validator.py /app/neurons/validator.py
COPY validator_models/automated_checks.py /app/validator_models/automated_checks.py

# =============================================================================
# Normalize timestamps on all copied application files
# This ensures COPY commands don't introduce timestamp variations
# =============================================================================
RUN find /app -type f -exec touch -t 197001010000.00 {} +

# Run the validator TEE service
# -u flag: unbuffered output (CRITICAL for debugging)
ENTRYPOINT ["python3", "-u", "/app/validator_tee/enclave/tee_service.py"]
